name: parallel-sessions
description: Rules for agents working in parallel sessions with auto-sync to main
scope: all-agents
priority: 95

# Zero human intervention design:
# - Each parallel session auto-syncs commits to main via post-commit hook
# - Agents check what other sessions are doing to avoid conflicts
# - Human just spawns sessions with `happy --yolo "task"`

rules:
  - name: check-other-sessions
    description: |
      At the start of significant work, check what other parallel sessions
      are working on to avoid conflicts.
    trigger: session_start, major_task
    action: |
      Run: uv run python -m pilot_core.worktree others
      This shows:
      - Other session names and descriptions
      - Files they've modified
      - Their latest commits

      AVOID modifying files that other sessions are actively working on.

  - name: check-conflicts-before-commit
    description: |
      Before committing, check if any files conflict with other sessions.
    trigger: before_commit
    action: |
      Run: uv run python -m pilot_core.worktree conflicts
      If conflicts detected:
      - Warn the user
      - Suggest coordination with the other session
      - Or proceed if changes are complementary (different parts of file)

  - name: auto-sync-awareness
    description: |
      Commits in parallel sessions auto-sync to main via post-commit hook.
      No manual merge needed. Agent should inform user of this.
    trigger: after_commit
    action: |
      The post-commit hook automatically:
      1. Rebases on latest main
      2. Merges to main (fast-forward if possible)
      3. Notifies other sessions

      If conflict occurs, hook will report it and agent should help resolve.

  - name: pull-before-major-work
    description: |
      Before starting major changes, pull latest from main to reduce conflicts.
    trigger: before_major_modification
    action: |
      Run: uv run python -m pilot_core.worktree pull
      This rebases current branch on latest main.

  - name: session-context-awareness
    description: |
      When human mentions another parallel session or agent, provide context.
    trigger: user_mentions_parallel_agent
    action: |
      If user says "the other agent working on X" or "parallel session Y":
      Run: uv run python -m pilot_core.worktree others --json
      Find the relevant session and report:
      - What they're working on (description)
      - What files they've modified
      - Their latest commit

      This helps coordinate without the human managing it.

  - name: conflict-resolution
    description: |
      If auto-sync fails due to conflict, help resolve it.
    trigger: sync_conflict
    action: |
      1. Run: uv run python -m pilot_core.worktree pull
      2. If rebase fails, inform user of conflicting files
      3. Help resolve conflicts (view diff, suggest resolution)
      4. After resolution: git add, git rebase --continue
      5. Commit again to trigger auto-sync

shared_files_requiring_coordination:
  - CLAUDE.md
  - agents/*.yaml
  - tools/*.py
  - lib/*.py
  - system/config.yaml
  - system/rules/*.yaml

how_to_check_other_sessions: |
  # See what other sessions are working on (recommended)
  uv run python -m pilot_core.worktree others

  # Check for conflicts with your staged changes
  uv run python -m pilot_core.worktree conflicts

  # List all active parallel sessions
  uv run python -m pilot_core.worktree list

  # Get detailed status
  uv run python -m pilot_core.worktree status

how_to_pull_latest_main: |
  # Rebase on latest main (do this before major work)
  uv run python -m pilot_core.worktree pull

how_commits_flow_to_main: |
  # Automatic! No human intervention needed.
  #
  # When you commit in a parallel session:
  # 1. post-commit hook runs auto_sync_to_main()
  # 2. Your branch is rebased on latest main
  # 3. Changes are merged to main
  # 4. Other sessions are notified
  #
  # If there's a conflict:
  # - Hook reports it
  # - Run: uv run python -m pilot_core.worktree pull
  # - Resolve conflicts
  # - Commit again

how_to_create_parallel_session: |
  # From main worktree (or happy --yolo handles this)
  uv run python -m pilot_core.worktree create "feature-name" --desc "What I'm working on"

  # Navigate to new worktree
  cd ../pilot-feature-name

  # Start new Claude Code session there

when_human_mentions_other_agent: |
  # If human says "the parallel agent is working on X" or
  # "check what agent/session Y is doing":

  # Get info about all other sessions
  uv run python -m pilot_core.worktree others

  # Then coordinate by:
  # - Avoiding files they've modified
  # - Checking for conflicts before committing
  # - Pulling main to get their changes
